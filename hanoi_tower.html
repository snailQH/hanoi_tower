<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ±‰è¯ºå¡”æ¸¸æˆ Patrick</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #333;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .description {
            text-align: center;
            max-width: 800px;
            margin-bottom: 20px;
            color: #555;
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .stats {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #fff;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            min-width: 100px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2980b9;
            margin-top: 5px;
        }

        select, button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: #3498db;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        select {
            background-color: white;
            color: #333;
            border: 1px solid #ccc;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        .game-container {
            position: relative;
            width: 800px;
            height: 400px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .towers-container {
            display: flex;
            justify-content: space-around;
            height: 320px;
            position: relative;
            margin-top: auto;
        }

        .tower {
            position: relative;
            width: 200px;
            height: 320px;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            cursor: pointer;
        }

        .rod {
            position: absolute;
            width: 20px;
            height: 280px;
            background-color: #7f8c8d;
            bottom: 0;
            border-radius: 10px 10px 0 0;
            z-index: 1;
        }

        .base {
            position: absolute;
            width: 180px;
            height: 20px;
            background-color: #7f8c8d;
            bottom: 0;
            border-radius: 5px;
            z-index: 1;
        }

        .disk {
            height: 30px;
            border-radius: 15px;
            margin-bottom: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            transition: transform 0.3s;
            z-index: 2;
            cursor: grab;
        }

        .disk:hover {
            transform: translateY(-5px);
        }

        .disk.dragging {
            opacity: 0.8;
            transform: scale(1.05);
            cursor: grabbing;
        }

        .labels {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 10px;
        }

        .tower-label {
            font-weight: bold;
            font-size: 18px;
            color: #2c3e50;
        }

        .message {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            display: none;
        }

        .message.success {
            background-color: #27ae60;
            color: white;
            display: block;
        }

        .message.error {
            background-color: #e74c3c;
            color: white;
            display: block;
        }

        .help {
            margin-top: 20px;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 5px;
            max-width: 800px;
        }

        .help h3 {
            margin-top: 0;
            color: #2c3e50;
        }

        .help ul {
            margin-bottom: 0;
            padding-left: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            max-width: 500px;
            text-align: center;
        }

        .modal-title {
            font-size: 24px;
            color: #2c3e50;
            margin-top: 0;
        }

        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            border-radius: 50%;
            pointer-events: none;
        }

        @media (max-width: 850px) {
            .game-container {
                width: 95%;
                height: auto;
            }
            
            .towers-container {
                height: 280px;
            }
            
            .tower {
                width: 30%;
            }
            
            .rod {
                height: 240px;
            }
        }

        /* æ·»åŠ åå­—è¾“å…¥è¡¨å•æ ·å¼ */
        .player-form {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        
        .player-form input {
            padding: 10px;
            width: 100%;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .player-form button {
            width: 100%;
            margin-top: 10px;
        }
        
        .player-info {
            background-color: #2980b9;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            margin-right: auto;
            display: none; /* åˆå§‹éšè— */
        }

        /* å¢å¼ºç§»åŠ¨è®¾å¤‡å“åº”å¼æ ·å¼ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .description {
                font-size: 14px;
                margin-bottom: 15px;
            }
            
            .player-form {
                max-width: 90%;
            }
            
            .controls {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .player-info {
                width: 100%;
                margin-bottom: 10px;
                text-align: center;
            }
            
            .stats {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }
            
            .stat {
                min-width: 80px;
                flex: 1;
            }
            
            .game-container {
                width: 100%;
                height: 300px;
                padding: 10px;
            }
            
            .towers-container {
                height: 250px;
            }
            
            .rod {
                height: 210px;
                width: 15px;
            }
            
            .base {
                width: 140px;
                height: 15px;
            }
            
            .disk {
                height: 25px;
                border-radius: 12px;
                font-size: 12px;
            }
            
            .tower-label {
                font-size: 16px;
            }
            
            .help {
                font-size: 14px;
                padding: 10px;
            }
            
            .help ul {
                padding-left: 15px;
            }
            
            .modal-content {
                width: 90%;
                padding: 20px;
                max-width: none;
            }
            
            .modal-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-buttons button {
                width: 100%;
            }
        }

        /* é’ˆå¯¹æ›´å°çš„æ‰‹æœºå±å¹• */
        @media (max-width: 480px) {
            .stat {
                padding: 5px 10px;
            }
            
            .stat-value {
                font-size: 18px;
            }
            
            .disk {
                height: 20px;
                font-size: 10px;
                margin-bottom: 3px;
            }
            
            /* è°ƒæ•´ç›˜å­çš„æœ€å¤§å®½åº¦ï¼Œç¡®ä¿åœ¨å°å±å¹•ä¸Šèƒ½é€‚åº” */
            .mobile-disk-adjust {
                max-width: 100px !important;
            }
        }
        
        /* æ·»åŠ è§¦æ‘¸æ“ä½œæ ·å¼ */
        .disk.selected {
            transform: translateY(-10px);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        /* å¢åŠ ç§»åŠ¨ç«¯æ“ä½œæç¤º */
        .mobile-hint {
            display: none;
            text-align: center;
            background-color: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 14px;
            color: #555;
        }
        
        @media (max-width: 768px) {
            .mobile-hint {
                display: block;
            }
        }

        .disk.touch-dragging {
            position: absolute;
            z-index: 1000;
            opacity: 0.8;
            transform: scale(1.05);
            transition: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        
        /* è§¦æ‘¸æ—¶çš„åé¦ˆæ•ˆæœ */
        .tower.tower-highlight {
            background-color: rgba(52, 152, 219, 0.2);
            border-radius: 10px;
        }
        
        /* å¯ä»¥æ”¾ç½®çš„æŒ‡ç¤º */
        .tower.can-drop {
            background-color: rgba(46, 204, 113, 0.2);
        }
        
        /* ä¸å¯æ”¾ç½®çš„æŒ‡ç¤º */
        .tower.cannot-drop {
            background-color: rgba(231, 76, 60, 0.2);
        }

        /* æ’è¡Œæ¦œæ ·å¼ */
        .leaderboard {
            margin-top: 30px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding: 20px;
            max-width: 800px;
            width: 100%;
        }
        
        .leaderboard h3 {
            color: #2c3e50;
            text-align: center;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .leaderboard-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .leaderboard-tab {
            padding: 8px 16px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            cursor: pointer;
            font-weight: bold;
        }
        
        .leaderboard-tab.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .leaderboard-tab:first-child {
            border-radius: 5px 0 0 5px;
        }
        
        .leaderboard-tab:last-child {
            border-radius: 0 5px 5px 0;
        }
        
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .leaderboard-table th,
        .leaderboard-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .leaderboard-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .leaderboard-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .leaderboard-table tr:hover {
            background-color: #f1f1f1;
        }
        
        .current-user {
            background-color: #e8f4fc !important;
            font-weight: bold;
        }
        
        .rank-1 .rank-cell {
            background-color: gold;
            color: #333;
            font-weight: bold;
        }
        
        .rank-2 .rank-cell {
            background-color: silver;
            color: #333;
            font-weight: bold;
        }
        
        .rank-3 .rank-cell {
            background-color: #cd7f32;
            color: white;
            font-weight: bold;
        }
        
        .leaderboard-footer {
            margin-top: 15px;
            text-align: center;
            font-size: 14px;
            color: #7f8c8d;
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .leaderboard {
                padding: 15px;
            }
            
            .leaderboard-table th,
            .leaderboard-table td {
                padding: 8px 10px;
                font-size: 14px;
            }
            
            .leaderboard-tab {
                padding: 6px 12px;
                font-size: 14px;
            }
        }

        /* åœ¨CSSéƒ¨åˆ†æ·»åŠ ä»¥ä¸‹æ ·å¼ï¼Œä¼˜åŒ–å°å±å¹•ä¸Šçš„æ’è¡Œæ¦œæ ‡ç­¾ */
        @media (max-width: 600px) {
            .leaderboard-tabs {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .leaderboard-tab {
                flex-grow: 1;
                text-align: center;
                padding: 5px 8px;
                font-size: 13px;
                border-radius: 4px !important; /* è¦†ç›–åŸæ¥çš„å·¦å³åœ†è§’è®¾ç½® */
                margin: 2px;
            }
            
            .leaderboard-tab:first-child,
            .leaderboard-tab:last-child {
                border-radius: 4px;
            }
        }
    </style>

    <!-- æ·»åŠ LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.2/dist/av-min.js"></script>
</head>
<body>
    <h1>æ±‰è¯ºå¡”æ¸¸æˆ</h1>
    
    <!-- æ·»åŠ ç©å®¶åå­—è¾“å…¥è¡¨å• -->
    <div id="playerForm" class="player-form">
        <h3>è¯·è¾“å…¥ä½ çš„åå­—</h3>
        <input type="text" id="playerNameInput" placeholder="è¯·è¾“å…¥ä½ çš„åå­—" maxlength="20">
        <button id="startGameButton">å¼€å§‹æ¸¸æˆ</button>
    </div>
    
    <div class="description">
        <p>æ±‰è¯ºå¡”æ˜¯ä¸€ä¸ªè‘—åçš„æ•°å­¦æ¸¸æˆæˆ–è°œé¢˜ï¼ŒåŒ…å«ä¸‰æ ¹æ†å’Œå¤šä¸ªç›´å¾„å„ä¸ç›¸åŒçš„åœ†ç›˜ã€‚æ¸¸æˆçš„ç›®æ ‡æ˜¯å°†æ‰€æœ‰åœ†ç›˜ä»æœ€å·¦è¾¹çš„æ†ç§»åŠ¨åˆ°æœ€å³è¾¹çš„æ†ï¼Œéµå¾ªä»¥ä¸‹è§„åˆ™ï¼š</p>
        <p>1. æ¯æ¬¡åªèƒ½ç§»åŠ¨ä¸€ä¸ªåœ†ç›˜ï¼›2. æ¯æ¬¡ç§»åŠ¨åªèƒ½å°†æœ€é¡¶ç«¯çš„åœ†ç›˜ç§»è‡³å¦ä¸€æ ¹æ†ï¼›3. ä¸èƒ½å°†å¤§åœ†ç›˜æ”¾åœ¨å°åœ†ç›˜ä¸Šé¢ã€‚</p>
    </div>

    <div class="controls">
        <!-- æ·»åŠ ç©å®¶ä¿¡æ¯æ˜¾ç¤º -->
        <div id="playerInfo" class="player-info">
            ç©å®¶: <span id="playerNameDisplay">åŒ¿å</span>
        </div>
        
        <div>
            <label for="disksCount">é€‰æ‹©ç›˜å­æ•°é‡:</label>
            <select id="disksCount">
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
            </select>
        </div>
        <button id="resetBtn">é‡æ–°å¼€å§‹</button>
        <button id="autoSolveBtn">è‡ªåŠ¨æ±‚è§£</button>
        <button id="undoBtn" disabled>æ’¤é”€</button>
    </div>

    <div class="stats">
        <div class="stat">
            <span>å½“å‰æ­¥æ•°</span>
            <span id="moveCount" class="stat-value">0</span>
        </div>
        <div class="stat">
            <span>æœ€ä½³æ­¥æ•°</span>
            <span id="optimalMoves" class="stat-value">7</span>
        </div>
        <div class="stat">
            <span>æ¸¸æˆæ—¶é—´</span>
            <span id="timer" class="stat-value">00:00</span>
        </div>
    </div>

    <div class="game-container">
        <div class="towers-container">
            <div class="tower" id="tower1">
                <div class="rod"></div>
                <div class="base"></div>
                <!-- åœ†ç›˜å°†åœ¨JSä¸­åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="tower" id="tower2">
                <div class="rod"></div>
                <div class="base"></div>
            </div>
            <div class="tower" id="tower3">
                <div class="rod"></div>
                <div class="base"></div>
            </div>
        </div>
        <div class="labels">
            <div class="tower-label">A</div>
            <div class="tower-label">B</div>
            <div class="tower-label">C</div>
        </div>
    </div>

    <div id="message" class="message"></div>

    <div class="help">
        <h3>æ¸¸æˆè¯´æ˜:</h3>
        <ul>
            <li>ç‚¹å‡»å¹¶æ‹–åŠ¨åœ†ç›˜å¯ä»¥ç§»åŠ¨å®ƒã€‚</li>
            <li>åªæœ‰æœ€é¡¶éƒ¨çš„åœ†ç›˜å¯ä»¥è¢«ç§»åŠ¨ã€‚</li>
            <li>è¾ƒå¤§çš„åœ†ç›˜ä¸èƒ½æ”¾åœ¨è¾ƒå°çš„åœ†ç›˜ä¸Šã€‚</li>
            <li>ä½ çš„ç›®æ ‡æ˜¯å°†æ‰€æœ‰åœ†ç›˜ä»å·¦ä¾§æ†ç§»åŠ¨åˆ°å³ä¾§æ†ã€‚</li>
            <li>å°è¯•ç”¨æœ€å°‘çš„æ­¥æ•°å®Œæˆï¼ï¼ˆæœ€å°‘æ­¥æ•°æ˜¯ 2<sup>n</sup>-1ï¼Œå…¶ä¸­næ˜¯ç›˜å­æ•°ï¼‰</li>
        </ul>
    </div>

    <!-- æ·»åŠ ç§»åŠ¨ç«¯æ“ä½œæç¤º -->
    <div class="mobile-hint">
        <p>ğŸ“± è§¦æ‘¸æ“ä½œæç¤º: å…ˆç‚¹å‡»è¦ç§»åŠ¨çš„æŸ±å­ï¼Œå†ç‚¹å‡»ç›®æ ‡æŸ±å­</p>
    </div>

    <div class="leaderboard" id="leaderboard">
        <h3>æ±‰è¯ºå¡”æŒ‘æˆ˜æ’è¡Œæ¦œ</h3>
        <div class="leaderboard-tabs">
            <div class="leaderboard-tab active" data-disks="3">3ç›˜</div>
            <div class="leaderboard-tab" data-disks="4">4ç›˜</div>
            <div class="leaderboard-tab" data-disks="5">5ç›˜</div>
            <div class="leaderboard-tab" data-disks="6">6ç›˜</div>
            <div class="leaderboard-tab" data-disks="7">7ç›˜</div>
            <div class="leaderboard-tab" data-disks="8">8ç›˜</div>
        </div>
        <div class="leaderboard-content">
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>æ’å</th>
                        <th>ç©å®¶</th>
                        <th>æ­¥æ•°</th>
                        <th>ç”¨æ—¶</th>
                        <th>å®Œæˆæ—¥æœŸ</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                    <tr>
                        <td colspan="5" style="text-align: center">åŠ è½½ä¸­...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="leaderboard-footer">
            æœ€ä½³è®°å½•å°†ä¼šè‡ªåŠ¨æäº¤ã€‚è¯·å…¬å¹³æ¸¸æˆï¼
        </div>
    </div>

    <!-- æ–°å¢é¡µè„š -->
    <div class="footer">
        <div class="visitor-counter">
            <span>ç´¯è®¡è®¿é—®: <span id="visitorCount" class="visitor-count">åŠ è½½ä¸­...</span></span>
        </div>
        <div class="author-info">
            <p>ä½œè€…: <a href="https://github.com/snailQH" target="_blank">Qinghui Li</a></p>
            <p>&copy; 2025 æ±‰è¯ºå¡”æ¸¸æˆ</p>
        </div>
    </div>

    <div id="victoryModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">æ­å–œ <span id="victoryPlayerName">ä½ </span>ï¼æˆåŠŸäº†ï¼</h2>
            <p><span id="victoryPlayerName2">ä½ </span>ç”¨äº† <span id="finalMoves">0</span> æ­¥å®Œæˆäº†æ±‰è¯ºå¡”æŒ‘æˆ˜ï¼</p>
            <p>ç”¨æ—¶: <span id="finalTime">00:00</span></p>
            <p id="performanceMessage"></p>
            
            <!-- æ·»åŠ æˆç»©æäº¤çŠ¶æ€ -->
            <p id="scoreSubmitStatus" style="color: #2980b9; font-weight: bold;"></p>
            
            <div class="modal-buttons">
                <button id="newGameBtn">æ–°æ¸¸æˆ</button>
                <button id="increaseDisksBtn">å¢åŠ éš¾åº¦</button>
                <button id="viewLeaderboardBtn">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€å˜é‡
        let disksCount = 3;
        let towers = [[], [], []];
        let moveCount = 0;
        let optimalMoves = 7; // æœ€ä½³æ­¥æ•° (2^n - 1)
        let gameStarted = false;
        let startTime = null;
        let timerInterval = null;
        let isDragging = false;
        let selectedDisk = null;
        let selectedTower = null;
        let moveHistory = [];
        let autoSolveInProgress = false;
        let playerName = "åŒ¿å"; // æ·»åŠ ç©å®¶åå­—å˜é‡
        
        // DOMå…ƒç´ 
        const playerFormEl = document.getElementById('playerForm');
        const playerNameInputEl = document.getElementById('playerNameInput');
        const startGameButtonEl = document.getElementById('startGameButton');
        const playerInfoEl = document.getElementById('playerInfo');
        const playerNameDisplayEl = document.getElementById('playerNameDisplay');
        const victoryPlayerNameEl = document.getElementById('victoryPlayerName');
        const victoryPlayerName2El = document.getElementById('victoryPlayerName2');
        const disksCountSelect = document.getElementById('disksCount');
        const resetBtn = document.getElementById('resetBtn');
        const autoSolveBtn = document.getElementById('autoSolveBtn');
        const undoBtn = document.getElementById('undoBtn');
        const moveCountEl = document.getElementById('moveCount');
        const optimalMovesEl = document.getElementById('optimalMoves');
        const timerEl = document.getElementById('timer');
        const messageEl = document.getElementById('message');
        const tower1El = document.getElementById('tower1');
        const tower2El = document.getElementById('tower2');
        const tower3El = document.getElementById('tower3');
        const towerEls = [tower1El, tower2El, tower3El];
        const victoryModal = document.getElementById('victoryModal');
        const finalMovesEl = document.getElementById('finalMoves');
        const finalTimeEl = document.getElementById('finalTime');
        const performanceMessageEl = document.getElementById('performanceMessage');
        const newGameBtn = document.getElementById('newGameBtn');
        const increaseDisksBtn = document.getElementById('increaseDisksBtn');
        const gameContainerEl = document.querySelector('.game-container');
        const statsEl = document.querySelector('.stats');
        
        // åˆå§‹éšè—æ¸¸æˆå…ƒç´ 
        gameContainerEl.style.display = 'none';
        statsEl.style.display = 'none';

        // å¤„ç†åå­—æäº¤å’Œæ¸¸æˆå¼€å§‹
        startGameButtonEl.addEventListener('click', function() {
            // è·å–ç©å®¶åå­—å¹¶å»é™¤ä¸¤ç«¯ç©ºæ ¼
            playerName = playerNameInputEl.value.trim();
            
            // å¦‚æœæ²¡æœ‰è¾“å…¥åå­—ï¼Œä½¿ç”¨é»˜è®¤å€¼
            if (!playerName) {
                playerName = "åŒ¿åç©å®¶";
            }
            
            // æ›´æ–°æ˜¾ç¤ºçš„ç©å®¶åå­—
            playerNameDisplayEl.textContent = playerName;
            
            // éšè—è¡¨å•ï¼Œæ˜¾ç¤ºæ¸¸æˆå…ƒç´ 
            playerFormEl.style.display = 'none';
            gameContainerEl.style.display = 'flex';
            statsEl.style.display = 'flex';
            playerInfoEl.style.display = 'block';
            
            // åˆå§‹åŒ–æ¸¸æˆ
            initGame();
        });
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            // é‡ç½®å˜é‡
            moveCount = 0;
            towers = [[], [], []];
            moveHistory = [];
            gameStarted = false;
            autoSolveInProgress = false;
            clearInterval(timerInterval);
            startTime = null;
            
            // æ›´æ–°UI
            moveCountEl.textContent = '0';
            timerEl.textContent = '00:00';
            messageEl.className = 'message';
            messageEl.textContent = '';
            undoBtn.disabled = true;
            
            // æ¸…ç©ºå¡”
            towerEls.forEach(tower => {
                // ä¿ç•™æ†å’Œåº•åº§
                const rod = tower.querySelector('.rod');
                const base = tower.querySelector('.base');
                tower.innerHTML = '';
                tower.appendChild(rod);
                tower.appendChild(base);
            });
            
            // ç”Ÿæˆç›˜å­
            disksCount = parseInt(disksCountSelect.value);
            optimalMoves = Math.pow(2, disksCount) - 1;
            optimalMovesEl.textContent = optimalMoves;
            
            // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨ç«¯ï¼Œå¹¶è°ƒæ•´ç›˜å­æœ€å¤§å®½åº¦
            const isMobile = window.innerWidth < 768;
            
            const maxWidth = isMobile ? 110 : 160; // ç§»åŠ¨ç«¯ç¼©å°æœ€å¤§ç›˜å­å®½åº¦
            const minWidth = isMobile ? 35 : 40;   // ç•¥å¾®è°ƒæ•´æœ€å°å®½åº¦
            const widthStep = (maxWidth - minWidth) / (disksCount - 1 || 1);
            
            const colors = [
                '#e74c3c', '#e67e22', '#f1c40f', '#2ecc71', 
                '#3498db', '#9b59b6', '#1abc9c', '#34495e'
            ];
            
            for (let i = disksCount; i > 0; i--) {
                const disk = document.createElement('div');
                disk.className = 'disk';
                if (isMobile) {
                    disk.classList.add('mobile-disk-adjust');
                }
                const width = maxWidth - (disksCount - i) * widthStep;
                disk.style.width = width + 'px';
                disk.style.backgroundColor = colors[(disksCount - i) % colors.length];
                disk.dataset.size = i;
                disk.textContent = i;
                
                // æ·»åŠ æ‹–æ‹½äº‹ä»¶
                disk.draggable = true;
                disk.addEventListener('dragstart', dragStart);
                disk.addEventListener('dragend', dragEnd);
                
                // æ·»åŠ åˆ°ç¬¬ä¸€ä¸ªå¡”å¹¶æ›´æ–°æ•°æ®æ¨¡å‹
                tower1El.appendChild(disk);
                towers[0].push(i);
            }

            // æ·»åŠ æ‹–æ”¾äº‹ä»¶åˆ°å¡”
            towerEls.forEach((tower, index) => {
                tower.addEventListener('dragover', (e) => dragOver(e, index));
                tower.addEventListener('drop', (e) => drop(e, index));
            });

            autoSolveBtn.disabled = false;
        }

        // æ‹–æ‹½ç›¸å…³å‡½æ•°
        function dragStart(e) {
            if (autoSolveInProgress) return;

            const tower = e.target.parentElement;
            const towerIndex = Array.from(towerEls).indexOf(tower);
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯é¡¶å±‚åœ†ç›˜
            const diskElements = tower.querySelectorAll('.disk');
            if (diskElements[diskElements.length - 1] !== e.target) {
                e.preventDefault();
                showMessage('åªèƒ½ç§»åŠ¨é¡¶éƒ¨çš„åœ†ç›˜ï¼', 'error');
                return;
            }

            if (!gameStarted) {
                startGame();
            }

            e.target.classList.add('dragging');
            selectedDisk = e.target;
            selectedTower = towerIndex;
            
            // è®¾ç½®æ‹–åŠ¨å›¾åƒï¼ˆå¯é€‰ï¼‰
            const dragImage = e.target.cloneNode(true);
            dragImage.style.opacity = '0.5';
            document.body.appendChild(dragImage);
            e.dataTransfer.setDragImage(dragImage, 50, 50);
            setTimeout(() => {
                document.body.removeChild(dragImage);
            }, 0);
        }

        function dragEnd(e) {
            e.target.classList.remove('dragging');
            selectedDisk = null;
        }

        function dragOver(e, towerIndex) {
            e.preventDefault();
        }

        function drop(e, targetTowerIndex) {
            e.preventDefault();
            if (selectedDisk === null || autoSolveInProgress) return;
            
            const sourceTowerIndex = selectedTower;
            moveDisk(sourceTowerIndex, targetTowerIndex);
        }

        // ç§»åŠ¨åœ†ç›˜
        function moveDisk(fromTower, toTower) {
            if (fromTower === toTower) return;
            
            // æ£€æŸ¥æºå¡”æ˜¯å¦æœ‰ç›˜å­
            if (towers[fromTower].length === 0) {
                showMessage('é€‰æ‹©çš„å¡”æ²¡æœ‰åœ†ç›˜ï¼', 'error');
                return;
            }
            
            // è·å–è¦ç§»åŠ¨çš„ç›˜å­å¤§å°
            const diskSize = towers[fromTower][towers[fromTower].length - 1];
            
            // æ£€æŸ¥ç›®æ ‡å¡”æ˜¯å¦å¯ä»¥æ”¾ç½®
            if (towers[toTower].length > 0 && towers[toTower][towers[toTower].length - 1] < diskSize) {
                showMessage('ä¸èƒ½å°†å¤§åœ†ç›˜æ”¾åœ¨å°åœ†ç›˜ä¸Šï¼', 'error');
                return;
            }
            
            // è®°å½•ç§»åŠ¨å†å²
            moveHistory.push({from: fromTower, to: toTower, diskSize: diskSize});
            undoBtn.disabled = false;
            
            // æ›´æ–°æ•°æ®æ¨¡å‹
            const movedDisk = towers[fromTower].pop();
            towers[toTower].push(movedDisk);
            
            // æ›´æ–°UI
            const diskElement = towerEls[fromTower].querySelector('.disk:last-child');
            towerEls[fromTower].removeChild(diskElement);
            towerEls[toTower].appendChild(diskElement);
            
            // æ›´æ–°æ­¥æ•°
            moveCount++;
            moveCountEl.textContent = moveCount;
            
            // æ£€æŸ¥èƒœåˆ©æ¡ä»¶
            if (towers[2].length === disksCount) {
                setTimeout(showVictory, 500);
            }
        }

        // æ’¤é”€ä¸Šä¸€æ­¥
        function undoMove() {
            if (moveHistory.length === 0 || autoSolveInProgress) return;
            
            const lastMove = moveHistory.pop();
            if (moveHistory.length === 0) {
                undoBtn.disabled = true;
            }
            
            // æ›´æ–°æ•°æ®æ¨¡å‹
            const diskSize = towers[lastMove.to].pop();
            towers[lastMove.from].push(diskSize);
            
            // æ›´æ–°UI
            const diskElement = towerEls[lastMove.to].querySelector('.disk:last-child');
            towerEls[lastMove.to].removeChild(diskElement);
            towerEls[lastMove.from].appendChild(diskElement);
            
            // æ›´æ–°æ­¥æ•°
            moveCount--;
            moveCountEl.textContent = moveCount;
        }

        // è‡ªåŠ¨æ±‚è§£
        async function autoSolve() {
            if (!gameStarted) {
                startGame();
            }
            
            autoSolveInProgress = true;
            autoSolveBtn.disabled = true;
            undoBtn.disabled = true;
            resetBtn.disabled = true;
            disksCountSelect.disabled = true;
            
            // é‡ç½®æ¸¸æˆåˆ°åˆå§‹çŠ¶æ€
            while (moveHistory.length > 0) {
                undoMove();
            }
            
            // é€’å½’æ±‚è§£æ±‰è¯ºå¡”
            await solveHanoiAnimation(disksCount, 0, 2, 1);
            
            autoSolveInProgress = false;
            resetBtn.disabled = false;
            disksCountSelect.disabled = false;
        }

        // æ±‰è¯ºå¡”é€’å½’æ±‚è§£ï¼ˆå¸¦åŠ¨ç”»ï¼‰
        async function solveHanoiAnimation(n, source, target, auxiliary) {
            if (n === 1) {
                await animateMove(source, target);
                return;
            }
            
            await solveHanoiAnimation(n-1, source, auxiliary, target);
            await animateMove(source, target);
            await solveHanoiAnimation(n-1, auxiliary, target, source);
        }

        // å¸¦å»¶è¿Ÿçš„ç§»åŠ¨åŠ¨ç”»
        function animateMove(fromTower, toTower) {
            return new Promise(resolve => {
                setTimeout(() => {
                    moveDisk(fromTower, toTower);
                    resolve();
                }, 300); // è°ƒæ•´å»¶è¿Ÿæ—¶é—´å¯ä»¥æ”¹å˜åŠ¨ç”»é€Ÿåº¦
            });
        }

        // å¼€å§‹æ¸¸æˆè®¡æ—¶
        function startGame() {
            gameStarted = true;
            startTime = new Date();
            timerInterval = setInterval(updateTimer, 1000);
        }

        // æ›´æ–°è®¡æ—¶å™¨
        function updateTimer() {
            if (!startTime) return;
            
            const currentTime = new Date();
            const elapsedSeconds = Math.floor((currentTime - startTime) / 1000);
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            
            timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type = '') {
            messageEl.textContent = text;
            messageEl.className = 'message';
            if (type) {
                messageEl.classList.add(type);
            }
            
            setTimeout(() => {
                messageEl.className = 'message';
            }, 3000);
        }

        // æ˜¾ç¤ºèƒœåˆ©æ¨¡æ€æ¡†
        function showVictory() {
            clearInterval(timerInterval);
            
            // æ›´æ–°èƒœåˆ©æ¨¡æ€æ¡†ä¸­çš„ç©å®¶åå­—
            victoryPlayerNameEl.textContent = playerName;
            victoryPlayerName2El.textContent = playerName;
            
            finalMovesEl.textContent = moveCount;
            finalTimeEl.textContent = timerEl.textContent;
            
            // æ ¹æ®æ€§èƒ½è®¡ç®—è¯„ä»·
            const perfRatio = moveCount / optimalMoves;
            let perfMessage = '';
            
            if (perfRatio === 1) {
                perfMessage = 'å¤ªæ£’äº†ï¼' + playerName + 'è¾¾åˆ°äº†ç†è®ºæœ€å°‘æ­¥æ•°ï¼';
                createConfetti();
            } else if (perfRatio < 1.2) {
                perfMessage = 'å‡ºè‰²çš„è¡¨ç°ï¼' + playerName + 'éå¸¸æ¥è¿‘æœ€ä¼˜è§£ï¼';
            } else if (perfRatio < 1.5) {
                perfMessage = 'ä¸é”™çš„å°è¯•ï¼å†æ¥å†å‰ï¼';
            } else if (perfRatio < 2) {
                perfMessage = playerName + 'å·²ç»å®Œæˆäº†æŒ‘æˆ˜ï¼Œä½†è¿˜æœ‰æ”¹è¿›çš„ç©ºé—´ï¼';
            } else {
                perfMessage = 'æŒ‘æˆ˜æˆåŠŸï¼å¤šç»ƒä¹ å¯ä»¥å‡å°‘ç§»åŠ¨æ¬¡æ•°ï¼';
            }
            
            performanceMessageEl.textContent = perfMessage;
            
            // æäº¤åˆ†æ•°
            document.getElementById('scoreSubmitStatus').textContent = 'æ­£åœ¨æäº¤æˆç»©...';
            submitScore();
            
            victoryModal.style.display = 'flex';
        }

        // åˆ›å»ºèƒœåˆ©æ—¶çš„äº”å½©çº¸å±‘æ•ˆæœ
        function createConfetti() {
            const colors = ['#f44336', '#2196f3', '#ffeb3b', '#4caf50', '#9c27b0', '#ff9800'];
            const confettiCount = 200;
            
            for (let i = 0; i < confettiCount; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    
                    // éšæœºä½ç½®
                    const startX = Math.random() * window.innerWidth;
                    confetti.style.left = startX + 'px';
                    confetti.style.top = '-10px';
                    
                    // éšæœºå¤§å°
                    const size = Math.random() * 10 + 5;
                    confetti.style.width = size + 'px';
                    confetti.style.height = size + 'px';
                    
                    document.body.appendChild(confetti);
                    
                    // æ·»åŠ éšæœºåŠ¨ç”»
                    const animationDuration = Math.random() * 3 + 2;
                    confetti.style.transition = `all ${animationDuration}s ease-out`;
                    
                    setTimeout(() => {
                        confetti.style.top = window.innerHeight + 'px';
                        confetti.style.left = (parseInt(confetti.style.left) + (Math.random() * 200 - 100)) + 'px';
                        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                        
                        // ç§»é™¤å…ƒç´ 
                        setTimeout(() => {
                            document.body.removeChild(confetti);
                        }, animationDuration * 1000);
                    }, 10);
                }, Math.random() * 1500);
            }
        }

        // äº‹ä»¶ç›‘å¬å™¨
        disksCountSelect.addEventListener('change', initGame);
        resetBtn.addEventListener('click', function() {
            if (confirm("é‡æ–°å¼€å§‹æ¸¸æˆï¼Ÿ")) {
                const changeNameToo = confirm("æ˜¯å¦åŒæ—¶æ›´æ¢ç©å®¶å§“åï¼Ÿ");
                if (changeNameToo) {
                    // æ˜¾ç¤ºåå­—è¾“å…¥æ¡†
                    gameContainerEl.style.display = 'none';
                    statsEl.style.display = 'none';
                    playerInfoEl.style.display = 'none';
                    playerFormEl.style.display = 'block';
                    playerNameInputEl.value = playerName;
                } else {
                    initGame();
                }
            }
        });
        autoSolveBtn.addEventListener('click', autoSolve);
        undoBtn.addEventListener('click', undoMove);
        newGameBtn.addEventListener('click', () => {
            victoryModal.style.display = 'none';
            initGame();
        });
        increaseDisksBtn.addEventListener('click', () => {
            victoryModal.style.display = 'none';
            const nextValue = Math.min(parseInt(disksCountSelect.value) + 1, 8);
            disksCountSelect.value = nextValue;
            initGame();
        });

        // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶æ”¯æŒ
        towerEls.forEach((tower, towerIndex) => {
            tower.addEventListener('touchstart', (e) => {
                if (autoSolveInProgress) return;
                
                // å¦‚æœå·²ç»é€‰ä¸­äº†ä¸€ä¸ªç›˜å­ï¼Œå°è¯•æ”¾ç½®
                if (selectedDisk) {
                    moveDisk(selectedTower, towerIndex);
                    selectedDisk = null;
                    selectedTower = null;
                    return;
                }
                
                // å¦åˆ™ï¼Œå°è¯•é€‰æ‹©ä¸€ä¸ªç›˜å­
                const disks = tower.querySelectorAll('.disk');
                if (disks.length === 0) return;
                
                const topDisk = disks[disks.length - 1];
                topDisk.classList.add('dragging');
                selectedDisk = topDisk;
                selectedTower = towerIndex;
                
                if (!gameStarted) {
                    startGame();
                }
                
                e.preventDefault(); // é˜²æ­¢æ»šåŠ¨
            });
        });

        // æ·»åŠ çª—å£å¤§å°è°ƒæ•´å¤„ç†
        window.addEventListener('resize', function() {
            // é‡æ–°è°ƒæ•´æ¸¸æˆå¸ƒå±€
            const isMobile = window.innerWidth < 768;
            const disks = document.querySelectorAll('.disk');
            
            if (isMobile) {
                disks.forEach(disk => disk.classList.add('mobile-disk-adjust'));
            } else {
                disks.forEach(disk => disk.classList.remove('mobile-disk-adjust'));
            }
        });

        // ä¿®æ”¹victoryModalå…³é—­æ–¹æ³•ä»¥é€‚åº”ç§»åŠ¨ç«¯
        document.addEventListener('touchstart', function(e) {
            if (e.target === victoryModal) {
                victoryModal.style.display = 'none';
                initGame();
            }
        });

        // ä¼˜åŒ–ç§»åŠ¨ç«¯åŠ è½½ä½“éªŒ
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                // é’ˆå¯¹ç§»åŠ¨è®¾å¤‡çš„é¢å¤–ä¼˜åŒ–
                document.body.classList.add('mobile-device');
                
                // é˜»æ­¢åŒå‡»ç¼©æ”¾
                document.addEventListener('dblclick', function(e) {
                    e.preventDefault();
                }, { passive: false });
                
                // ç¦ç”¨é¡µé¢ç¼©æ”¾
                document.addEventListener('touchmove', function(e) {
                    if (e.scale !== 1) {
                        e.preventDefault();
                    }
                }, { passive: false });
            }
            // åŠ è½½æ’è¡Œæ¦œ
            loadLeaderboard(3);
            
            // æ›´æ–°è®¿é—®è®¡æ•°
            updateVisitorCount();
        });

        // åˆå§‹åŒ–æ¸¸æˆ
        initGame();

        // è§¦æ‘¸æ‹–æ‹½ç›¸å…³å˜é‡
        let touchDragging = false;
        let touchDragDisk = null;
        let touchStartX = 0;
        let touchStartY = 0;
        let originalTower = null;
        let originalPosition = { top: 0, left: 0 };
        let lastTouchedTower = null;

        // ä¸»è„šæœ¬åº•éƒ¨æ·»åŠ è§¦æ‘¸æ‹–æ‹½ç›¸å…³åŠŸèƒ½
        function initTouchDragEvents() {
            // ç§»é™¤ç°æœ‰çš„è§¦æ‘¸äº‹ä»¶ç›‘å¬å™¨
            towerEls.forEach(tower => {
                tower.removeEventListener('touchstart', tower._touchHandler);
            });
            
            // æ·»åŠ è§¦æ‘¸å¼€å§‹äº‹ä»¶
            towerEls.forEach((tower, towerIndex) => {
                tower.addEventListener('touchstart', function(e) {
                    if (autoSolveInProgress) return;
                    
                    // å¦‚æœå·²ç»åœ¨æ‹–åŠ¨ä¸­ï¼Œå¿½ç•¥
                    if (touchDragging) return;
                    
                    const rect = tower.getBoundingClientRect();
                    const touch = e.touches[0];
                    const x = touch.clientX - rect.left;
                    const y = touch.clientY - rect.top;
                    
                    // è·å–å¡”ä¸Šçš„æ‰€æœ‰ç›˜å­
                    const disks = tower.querySelectorAll('.disk');
                    if (disks.length === 0) return;
                    
                    // åªèƒ½ç§»åŠ¨æœ€é¡¶éƒ¨çš„ç›˜å­
                    const topDisk = disks[disks.length - 1];
                    const diskRect = topDisk.getBoundingClientRect();
                    
                    // æ£€æŸ¥è§¦æ‘¸ç‚¹æ˜¯å¦åœ¨é¡¶éƒ¨ç›˜å­ä¸Š
                    if (touch.clientX >= diskRect.left && 
                        touch.clientX <= diskRect.right && 
                        touch.clientY >= diskRect.top && 
                        touch.clientY <= diskRect.bottom) {
                        
                        // å¼€å§‹æ¸¸æˆè®¡æ—¶ï¼ˆå¦‚æœè¿˜æ²¡å¼€å§‹ï¼‰
                        if (!gameStarted) {
                            startGame();
                        }
                        
                        // è®°å½•åˆå§‹è§¦æ‘¸ä½ç½®å’ŒåŸå§‹å¡”
                        touchStartX = touch.clientX;
                        touchStartY = touch.clientY;
                        originalTower = towerIndex;
                        originalPosition = {
                            top: diskRect.top,
                            left: diskRect.left
                        };
                        
                        // åˆ›å»ºæ‹–åŠ¨å…‹éš†
                        touchDragDisk = topDisk.cloneNode(true);
                        touchDragDisk.classList.add('touch-dragging');
                        touchDragDisk.style.width = `${diskRect.width}px`;
                        touchDragDisk.style.left = `${diskRect.left}px`;
                        touchDragDisk.style.top = `${diskRect.top}px`;
                        document.body.appendChild(touchDragDisk);
                        
                        // æ ‡è®°æ‹–åŠ¨çŠ¶æ€
                        touchDragging = true;
                        
                        // é«˜äº®åŸå§‹å¡”
                        tower.classList.add('tower-highlight');
                        
                        e.preventDefault(); // é˜²æ­¢æ»šåŠ¨
                    }
                });
            });
            
            // æ·»åŠ è§¦æ‘¸ç§»åŠ¨äº‹ä»¶ï¼ˆå…¨å±€ï¼‰
            document.addEventListener('touchmove', function(e) {
                if (!touchDragging || !touchDragDisk) return;
                
                const touch = e.touches[0];
                
                // è®¡ç®—ç§»åŠ¨è·ç¦»
                const deltaX = touch.clientX - touchStartX;
                const deltaY = touch.clientY - touchStartY;
                
                // ç§»åŠ¨å…‹éš†çš„ç›˜å­
                touchDragDisk.style.left = `${originalPosition.left + deltaX}px`;
                touchDragDisk.style.top = `${originalPosition.top + deltaY}px`;
                
                // æ£€æµ‹æ˜¯å¦åœ¨ä»»ä½•å¡”ä¸Šæ–¹
                let foundTower = false;
                towerEls.forEach((tower, index) => {
                    // ç§»é™¤ä¹‹å‰çš„é«˜äº®
                    if (index !== originalTower) {
                        tower.classList.remove('tower-highlight', 'can-drop', 'cannot-drop');
                    }
                    
                    const rect = tower.getBoundingClientRect();
                    if (touch.clientX >= rect.left && 
                        touch.clientX <= rect.right && 
                        touch.clientY >= rect.top && 
                        touch.clientY <= rect.bottom) {
                        
                        foundTower = true;
                        lastTouchedTower = index;
                        
                        // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ”¾ç½®
                        const canPlace = canPlaceDisk(originalTower, index);
                        
                        // é«˜äº®å½“å‰å¡”
                        if (index !== originalTower) {
                            tower.classList.add(canPlace ? 'can-drop' : 'cannot-drop');
                        }
                    }
                });
                
                if (!foundTower) {
                    lastTouchedTower = null;
                }
                
                e.preventDefault(); // é˜²æ­¢æ»šåŠ¨
            }, { passive: false });
            
            // æ·»åŠ è§¦æ‘¸ç»“æŸäº‹ä»¶ï¼ˆå…¨å±€ï¼‰
            document.addEventListener('touchend', function(e) {
                if (!touchDragging) return;
                
                // ç§»é™¤æ‹–åŠ¨å…‹éš†
                if (touchDragDisk && touchDragDisk.parentNode) {
                    touchDragDisk.parentNode.removeChild(touchDragDisk);
                }
                
                // ç§»é™¤æ‰€æœ‰é«˜äº®
                towerEls.forEach(tower => {
                    tower.classList.remove('tower-highlight', 'can-drop', 'cannot-drop');
                });
                
                // å¦‚æœæœ‰ç›®æ ‡å¡”ï¼Œå°è¯•ç§»åŠ¨
                if (lastTouchedTower !== null && lastTouchedTower !== originalTower) {
                    moveDisk(originalTower, lastTouchedTower);
                }
                
                // é‡ç½®çŠ¶æ€
                touchDragging = false;
                touchDragDisk = null;
                originalTower = null;
                lastTouchedTower = null;
            });
        }

        // æ£€æŸ¥æ˜¯å¦å¯ä»¥å°†ç›˜å­ä»æºå¡”ç§»åŠ¨åˆ°ç›®æ ‡å¡”
        function canPlaceDisk(fromTower, toTower) {
            // æ£€æŸ¥æºå¡”æ˜¯å¦æœ‰ç›˜å­
            if (towers[fromTower].length === 0) {
                return false;
            }
            
            // è·å–è¦ç§»åŠ¨çš„ç›˜å­å¤§å°
            const diskSize = towers[fromTower][towers[fromTower].length - 1];
            
            // æ£€æŸ¥ç›®æ ‡å¡”æ˜¯å¦å¯ä»¥æ”¾ç½®
            if (towers[toTower].length > 0 && towers[toTower][towers[toTower].length - 1] < diskSize) {
                return false;
            }
            
            return true;
        }

        // ä¿®æ”¹åŸæœ‰çš„document.addEventListener('DOMContentLoaded')äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                // é’ˆå¯¹ç§»åŠ¨è®¾å¤‡çš„é¢å¤–ä¼˜åŒ–
                document.body.classList.add('mobile-device');
                
                // åˆå§‹åŒ–è§¦æ‘¸æ‹–æ‹½
                initTouchDragEvents();
                
                // é˜»æ­¢åŒå‡»ç¼©æ”¾
                document.addEventListener('dblclick', function(e) {
                    e.preventDefault();
                }, { passive: false });
                
                // ç¦ç”¨é¡µé¢ç¼©æ”¾
                document.addEventListener('touchmove', function(e) {
                    if (e.scale !== 1 && e.scale !== undefined) {
                        e.preventDefault();
                    }
                }, { passive: false });
            }

            // åŠ è½½æ’è¡Œæ¦œ
            loadLeaderboard(3);
        });

        // æ¸¸æˆåˆå§‹åŒ–å®Œæˆåè°ƒç”¨è§¦æ‘¸äº‹ä»¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            // åˆå§‹åŒ–è§¦æ‘¸æ‹–æ‹½
            initTouchDragEvents();
        });

        // LeanCloud åˆå§‹åŒ–
        AV.init({
            appId: 'AGDWKZ8xlWjfvAg7OjqPT0Q3-gzGzoHsz', // æ›¿æ¢ä¸ºä½ çš„ LeanCloud åº”ç”¨ ID
            appKey: 'plrVugpDFgKVJ4XLh2vxhftS', // æ›¿æ¢ä¸ºä½ çš„ LeanCloud åº”ç”¨ Key
            serverURL: 'https://agdwkz8x.lc-cn-n1-shared.com' // æ›¿æ¢ä¸ºä½ çš„ LeanCloud API æœåŠ¡å™¨åœ°å€
        });
        
        // æ’è¡Œæ¦œç›¸å…³å˜é‡
        let currentLeaderboardDiskCount = 3;
        const Score = AV.Object.extend('Score');
        
        // è®¿é—®è®¡æ•°åŠŸèƒ½
        async function updateVisitorCount() {
            try {
                // æŸ¥è¯¢Counterå¯¹è±¡
                const query = new AV.Query('Counter');
                query.equalTo('name', 'visitorCount');
                let counter = await query.first();
                
                // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ª
                if (!counter) {
                    counter = new AV.Object('Counter');
                    counter.set('name', 'visitorCount');
                    counter.set('count', 0);
                }
                
                // å¢åŠ è®¡æ•°
                counter.increment('count');
                await counter.save();
                
                // æ˜¾ç¤ºè®¿é—®æ¬¡æ•°
                document.getElementById('visitorCount').textContent = counter.get('count');
            } catch (error) {
                console.error('æ›´æ–°è®¿é—®è®¡æ•°å¤±è´¥:', error);
                document.getElementById('visitorCount').textContent = 'æ— æ³•è·å–';
            }
        }
        
        // æäº¤åˆ†æ•°åˆ° LeanCloud
        async function submitScore() {
            if (!gameStarted || moveCount === 0) return;
            
            try {
                const score = new Score();
                
                // è®¾ç½®åˆ†æ•°å±æ€§
                score.set('playerName', playerName);
                score.set('diskCount', disksCount);
                score.set('moves', moveCount);
                score.set('time', timerEl.textContent);
                score.set('timeInSeconds', calculateTimeInSeconds(timerEl.textContent));
                score.set('timestamp', new Date());
                
                // ä¿å­˜åˆ†æ•°
                await score.save();
                document.getElementById('scoreSubmitStatus').textContent = 'æˆç»©å·²æäº¤è‡³æ’è¡Œæ¦œï¼';
                
                // é‡æ–°åŠ è½½æ’è¡Œæ¦œ
                loadLeaderboard(disksCount);
            } catch (error) {
                console.error('æäº¤åˆ†æ•°å¤±è´¥:', error);
                document.getElementById('scoreSubmitStatus').textContent = 'æˆç»©æäº¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚';
            }
        }
        
        // åŠ è½½æ’è¡Œæ¦œæ•°æ®
        async function loadLeaderboard(diskCount) {
            const leaderboardBody = document.getElementById('leaderboardBody');
            leaderboardBody.innerHTML = '<tr><td colspan="5" style="text-align: center">åŠ è½½ä¸­...</td></tr>';
            currentLeaderboardDiskCount = diskCount;
            
            try {
                // åˆ›å»ºæŸ¥è¯¢
                const query = new AV.Query('Score');
                query.equalTo('diskCount', diskCount);
                query.ascending('moves'); // é¦–å…ˆæŒ‰æ­¥æ•°å‡åº
                query.ascending('timeInSeconds'); // ç„¶åæŒ‰æ—¶é—´å‡åº
                query.limit(20); // è·å–å‰20å
                
                // æ‰§è¡ŒæŸ¥è¯¢
                const scores = await query.find();
                
                // æ›´æ–°æ’è¡Œæ¦œUI
                updateLeaderboardUI(scores);
            } catch (error) {
                console.error('åŠ è½½æ’è¡Œæ¦œå¤±è´¥:', error);
                leaderboardBody.innerHTML = '<tr><td colspan="5" style="text-align: center">åŠ è½½æ’è¡Œæ¦œå¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚</td></tr>';
            }
        }
        
        // æ›´æ–°æ’è¡Œæ¦œUI
        function updateLeaderboardUI(scores) {
            const leaderboardBody = document.getElementById('leaderboardBody');
            
            if (scores.length === 0) {
                leaderboardBody.innerHTML = '<tr><td colspan="5" style="text-align: center">æš‚æ— è®°å½•</td></tr>';
                return;
            }
            
            // æ¸…ç©ºæ’è¡Œæ¦œ
            leaderboardBody.innerHTML = '';
            
            // æ·»åŠ åˆ†æ•°è¡Œ
            scores.forEach((score, index) => {
                const rank = index + 1;
                const rowData = score.toJSON();
                const date = new Date(rowData.timestamp);
                const dateString = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                
                // åˆ›å»ºè¡Œ
                const row = document.createElement('tr');
                row.className = `rank-${rank}`;
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ç©å®¶
                if (rowData.playerName === playerName) {
                    row.classList.add('current-user');
                }
                
                // è®¾ç½®è¡Œå†…å®¹
                row.innerHTML = `
                    <td class="rank-cell">${rank}</td>
                    <td>${rowData.playerName}</td>
                    <td>${rowData.moves}</td>
                    <td>${rowData.time}</td>
                    <td>${dateString}</td>
                `;
                
                leaderboardBody.appendChild(row);
            });
        }
        
        // å°†æ—¶é—´å­—ç¬¦ä¸²è½¬æ¢ä¸ºç§’æ•°ï¼Œç”¨äºæ’åº
        function calculateTimeInSeconds(timeString) {
            const [minutes, seconds] = timeString.split(':').map(Number);
            return minutes * 60 + seconds;
        }
        
        // åˆ‡æ¢æ’è¡Œæ¦œæ ‡ç­¾
        document.querySelectorAll('.leaderboard-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // ç§»é™¤æ‰€æœ‰æ´»åŠ¨æ ‡ç­¾ç±»
                document.querySelectorAll('.leaderboard-tab').forEach(t => {
                    t.classList.remove('active');
                });
                
                // ä¸ºå½“å‰æ ‡ç­¾æ·»åŠ æ´»åŠ¨ç±»
                this.classList.add('active');
                
                // åŠ è½½ç›¸åº”çš„æ’è¡Œæ¦œ
                const diskCount = parseInt(this.dataset.disks);
                loadLeaderboard(diskCount);
            });
        });
        
        // æŸ¥çœ‹æ’è¡Œæ¦œæŒ‰é’®
        document.getElementById('viewLeaderboardBtn').addEventListener('click', function() {
            victoryModal.style.display = 'none';
            document.getElementById('leaderboard').scrollIntoView({ behavior: 'smooth' });
        });
    </script>
</body>
</html>